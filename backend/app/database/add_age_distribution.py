#!/usr/bin/env python3
"""
年齢層別人口データを追加するスクリプト
"""
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker
from app.models.area import Area
from app.core.config import settings

# サンプルデータ（実際のデータは東京都オープンデータから取得予定）
AGE_DISTRIBUTION_DATA = {
    "千代田区": {"0-14": 7821, "15-64": 45823, "65+": 11356, "0-4": 2607, "5-9": 2607, "10-14": 2607, "15-19": 2291, "20-29": 9165, "30-39": 9165, "40-49": 9165, "50-59": 9165, "60-64": 4582, "65-74": 6814, "75+": 4542},
    "中央区": {"0-14": 23619, "15-64": 123456, "65+": 26925, "0-4": 7873, "5-9": 7873, "10-14": 7873, "15-19": 6173, "20-29": 24691, "30-39": 24691, "40-49": 24691, "50-59": 24691, "60-64": 12346, "65-74": 16155, "75+": 10770},
    "港区": {"0-14": 37843, "15-64": 197562, "65+": 42595, "0-4": 12614, "5-9": 12614, "10-14": 12615, "15-19": 9878, "20-29": 39512, "30-39": 39512, "40-49": 39512, "50-59": 39512, "60-64": 19756, "65-74": 25557, "75+": 17038},
    "新宿区": {"0-14": 29876, "15-64": 254321, "65+": 65803, "0-4": 9959, "5-9": 9959, "10-14": 9958, "15-19": 12716, "20-29": 50864, "30-39": 50864, "40-49": 50864, "50-59": 50864, "60-64": 25432, "65-74": 39482, "75+": 26321},
    "文京区": {"0-14": 29345, "15-64": 167890, "65+": 42765, "0-4": 9782, "5-9": 9782, "10-14": 9781, "15-19": 8395, "20-29": 33578, "30-39": 33578, "40-49": 33578, "50-59": 33578, "60-64": 16789, "65-74": 25659, "75+": 17106},
    "台東区": {"0-14": 19876, "15-64": 143210, "65+": 51914, "0-4": 6625, "5-9": 6625, "10-14": 6626, "15-19": 7161, "20-29": 28642, "30-39": 28642, "40-49": 28642, "50-59": 28642, "60-64": 14321, "65-74": 31148, "75+": 20766},
    "墨田区": {"0-14": 30123, "15-64": 187654, "65+": 62223, "0-4": 10041, "5-9": 10041, "10-14": 10041, "15-19": 9383, "20-29": 37531, "30-39": 37531, "40-49": 37531, "50-59": 37531, "60-64": 18765, "65-74": 37334, "75+": 24889},
    "江東区": {"0-14": 69876, "15-64": 378901, "65+": 106223, "0-4": 23292, "5-9": 23292, "10-14": 23292, "15-19": 18945, "20-29": 75780, "30-39": 75780, "40-49": 75780, "50-59": 75780, "60-64": 37890, "65-74": 63734, "75+": 42489},
    "品川区": {"0-14": 46789, "15-64": 298765, "65+": 82446, "0-4": 15596, "5-9": 15596, "10-14": 15597, "15-19": 14938, "20-29": 59753, "30-39": 59753, "40-49": 59753, "50-59": 59753, "60-64": 29877, "65-74": 49468, "75+": 32978},
    "目黒区": {"0-14": 31234, "15-64": 210987, "65+": 59779, "0-4": 10411, "5-9": 10411, "10-14": 10412, "15-19": 10549, "20-29": 42197, "30-39": 42197, "40-49": 42197, "50-59": 42197, "60-64": 21099, "65-74": 35867, "75+": 23912},
    "大田区": {"0-14": 82345, "15-64": 523456, "65+": 172199, "0-4": 27448, "5-9": 27448, "10-14": 27449, "15-19": 26173, "20-29": 104691, "30-39": 104691, "40-49": 104691, "50-59": 104691, "60-64": 52346, "65-74": 103319, "75+": 68880},
    "世田谷区": {"0-14": 106789, "15-64": 687654, "65+": 195557, "0-4": 35596, "5-9": 35596, "10-14": 35597, "15-19": 34383, "20-29": 137531, "30-39": 137531, "40-49": 137531, "50-59": 137531, "60-64": 68765, "65-74": 117334, "75+": 78223},
    "渋谷区": {"0-14": 23456, "15-64": 187654, "65+": 43890, "0-4": 7819, "5-9": 7819, "10-14": 7818, "15-19": 9383, "20-29": 37531, "30-39": 37531, "40-49": 37531, "50-59": 37531, "60-64": 18765, "65-74": 26334, "75+": 17556},
    "中野区": {"0-14": 28901, "15-64": 256789, "65+": 68310, "0-4": 9634, "5-9": 9634, "10-14": 9633, "15-19": 12839, "20-29": 51358, "30-39": 51358, "40-49": 51358, "50-59": 51358, "60-64": 25679, "65-74": 40986, "75+": 27324},
    "杉並区": {"0-14": 58901, "15-64": 412345, "65+": 119754, "0-4": 19634, "5-9": 19634, "10-14": 19633, "15-19": 20617, "20-29": 82469, "30-39": 82469, "40-49": 82469, "50-59": 82469, "60-64": 41235, "65-74": 71852, "75+": 47902},
    "豊島区": {"0-14": 23456, "15-64": 234567, "65+": 62977, "0-4": 7819, "5-9": 7819, "10-14": 7818, "15-19": 11728, "20-29": 46913, "30-39": 46913, "40-49": 46913, "50-59": 46913, "60-64": 23457, "65-74": 37786, "75+": 25191},
    "北区": {"0-14": 36789, "15-64": 234567, "65+": 88644, "0-4": 12263, "5-9": 12263, "10-14": 12263, "15-19": 11728, "20-29": 46913, "30-39": 46913, "40-49": 46913, "50-59": 46913, "60-64": 23457, "65-74": 53186, "75+": 35458},
    "荒川区": {"0-14": 23456, "15-64": 156789, "65+": 56755, "0-4": 7819, "5-9": 7819, "10-14": 7818, "15-19": 7839, "20-29": 31358, "30-39": 31358, "40-49": 31358, "50-59": 31358, "60-64": 15679, "65-74": 34053, "75+": 22702},
    "板橋区": {"0-14": 61234, "15-64": 412345, "65+": 136421, "0-4": 20411, "5-9": 20411, "10-14": 20412, "15-19": 20617, "20-29": 82469, "30-39": 82469, "40-49": 82469, "50-59": 82469, "60-64": 41235, "65-74": 81853, "75+": 54568},
    "練馬区": {"0-14": 89012, "15-64": 523456, "65+": 167532, "0-4": 29671, "5-9": 29671, "10-14": 29670, "15-19": 26173, "20-29": 104691, "30-39": 104691, "40-49": 104691, "50-59": 104691, "60-64": 52346, "65-74": 100519, "75+": 67013},
    "足立区": {"0-14": 78901, "15-64": 456789, "65+": 184310, "0-4": 26300, "5-9": 26300, "10-14": 26301, "15-19": 22839, "20-29": 91358, "30-39": 91358, "40-49": 91358, "50-59": 91358, "60-64": 45679, "65-74": 110586, "75+": 73724},
    "葛飾区": {"0-14": 51234, "15-64": 312345, "65+": 116421, "0-4": 17078, "5-9": 17078, "10-14": 17078, "15-19": 15617, "20-29": 62469, "30-39": 62469, "40-49": 62469, "50-59": 62469, "60-64": 31235, "65-74": 69853, "75+": 46568},
    "江戸川区": {"0-14": 91234, "15-64": 489012, "65+": 149754, "0-4": 30411, "5-9": 30411, "10-14": 30412, "15-19": 24451, "20-29": 97802, "30-39": 97802, "40-49": 97802, "50-59": 97802, "60-64": 48901, "65-74": 89852, "75+": 59902}
}

def add_age_distribution():
    """年齢層データを追加"""
    engine = create_engine(settings.DATABASE_URL)
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    db = SessionLocal()
    
    try:
        # SQLiteの場合、PRAGMAを使用してカラムの存在を確認
        try:
            # カラムが存在しない場合は追加
            db.execute(text("ALTER TABLE areas ADD COLUMN age_distribution JSON"))
            db.commit()
            print("age_distributionカラムを追加しました")
        except Exception as e:
            # カラムが既に存在する場合はスキップ
            print("age_distributionカラムは既に存在します")
        
        # 各区のデータを更新
        for area_name, age_data in AGE_DISTRIBUTION_DATA.items():
            area = db.query(Area).filter(Area.name == area_name).first()
            if area:
                area.age_distribution = age_data
                print(f"{area_name}の年齢層データを追加しました")
            else:
                print(f"警告: {area_name}が見つかりません")
        
        db.commit()
        print("年齢層データの追加が完了しました")
        
    except Exception as e:
        print(f"エラーが発生しました: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    add_age_distribution()