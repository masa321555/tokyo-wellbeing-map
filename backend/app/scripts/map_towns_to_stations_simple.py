#!/usr/bin/env python3
"""
簡易的な町名と駅のマッピングスクリプト
手動で主要な駅と路線の対応を定義
"""
import sys
import csv
import json
from pathlib import Path
from typing import Dict, List, Optional

# プロジェクトルートを追加
sys.path.append(str(Path(__file__).parent.parent.parent))

# 東京23区の主要駅と路線のマッピング（手動定義）
STATION_LINE_MAPPING = {
    # 千代田区
    "東京": ["JR山手線", "JR京浜東北線", "JR東海道線", "JR中央線", "東京メトロ丸ノ内線"],
    "有楽町": ["JR山手線", "JR京浜東北線", "東京メトロ有楽町線"],
    "秋葉原": ["JR山手線", "JR京浜東北線", "JR総武線", "東京メトロ日比谷線", "つくばエクスプレス"],
    "神田": ["JR山手線", "JR京浜東北線", "JR中央線", "東京メトロ銀座線"],
    "御茶ノ水": ["JR中央線", "JR総武線", "東京メトロ丸ノ内線", "東京メトロ千代田線"],
    
    # 中央区
    "銀座": ["東京メトロ銀座線", "東京メトロ丸ノ内線", "東京メトロ日比谷線"],
    "日本橋": ["東京メトロ銀座線", "東京メトロ東西線", "都営浅草線"],
    "築地": ["東京メトロ日比谷線"],
    "月島": ["東京メトロ有楽町線", "都営大江戸線"],
    
    # 港区
    "品川": ["JR山手線", "JR京浜東北線", "JR東海道線", "京急本線"],
    "浜松町": ["JR山手線", "JR京浜東北線", "東京モノレール"],
    "新橋": ["JR山手線", "JR京浜東北線", "JR東海道線", "東京メトロ銀座線", "都営浅草線"],
    "六本木": ["東京メトロ日比谷線", "都営大江戸線"],
    "麻布十番": ["東京メトロ南北線", "都営大江戸線"],
    
    # 新宿区
    "新宿": ["JR山手線", "JR埼京線", "JR中央線", "JR湘南新宿ライン", "小田急線", "京王線", "東京メトロ丸ノ内線", "東京メトロ副都心線", "都営新宿線", "都営大江戸線"],
    "高田馬場": ["JR山手線", "東京メトロ東西線", "西武新宿線"],
    "四ツ谷": ["JR中央線", "東京メトロ丸ノ内線", "東京メトロ南北線"],
    "市ヶ谷": ["JR中央線", "東京メトロ有楽町線", "東京メトロ南北線", "都営新宿線"],
    
    # 文京区
    "後楽園": ["東京メトロ丸ノ内線", "東京メトロ南北線"],
    "本郷三丁目": ["東京メトロ丸ノ内線", "都営大江戸線"],
    "根津": ["東京メトロ千代田線"],
    "千駄木": ["東京メトロ千代田線"],
    
    # 台東区
    "上野": ["JR山手線", "JR京浜東北線", "JR常磐線", "JR宇都宮線", "JR高崎線", "東京メトロ銀座線", "東京メトロ日比谷線"],
    "浅草": ["東京メトロ銀座線", "都営浅草線", "東武伊勢崎線", "つくばエクスプレス"],
    "御徒町": ["JR山手線", "JR京浜東北線"],
    "鶯谷": ["JR山手線", "JR京浜東北線"],
    
    # 墨田区
    "錦糸町": ["JR総武線", "東京メトロ半蔵門線"],
    "両国": ["JR総武線", "都営大江戸線"],
    "押上": ["東京メトロ半蔵門線", "都営浅草線", "京成押上線", "東武伊勢崎線"],
    "曳舟": ["東武伊勢崎線", "東武亀戸線"],
    
    # 江東区
    "亀戸": ["JR総武線", "東武亀戸線"],
    "門前仲町": ["東京メトロ東西線", "都営大江戸線"],
    "豊洲": ["東京メトロ有楽町線", "ゆりかもめ"],
    "新木場": ["JR京葉線", "東京メトロ有楽町線", "りんかい線"],
    
    # 品川区
    "大井町": ["JR京浜東北線", "東急大井町線", "りんかい線"],
    "五反田": ["JR山手線", "都営浅草線", "東急池上線"],
    "目黒": ["JR山手線", "東京メトロ南北線", "都営三田線", "東急目黒線"],
    "大崎": ["JR山手線", "JR埼京線", "JR湘南新宿ライン", "りんかい線"],
    
    # 目黒区
    "中目黒": ["東京メトロ日比谷線", "東急東横線"],
    "学芸大学": ["東急東横線"],
    "自由が丘": ["東急東横線", "東急大井町線"],
    "都立大学": ["東急東横線"],
    
    # 大田区
    "蒲田": ["JR京浜東北線", "東急池上線", "東急多摩川線"],
    "大森": ["JR京浜東北線"],
    "田園調布": ["東急東横線", "東急目黒線"],
    "羽田空港": ["京急空港線", "東京モノレール"],
    
    # 世田谷区
    "下北沢": ["小田急線", "京王井の頭線"],
    "三軒茶屋": ["東急田園都市線", "東急世田谷線"],
    "二子玉川": ["東急田園都市線", "東急大井町線"],
    "成城学園前": ["小田急線"],
    
    # 渋谷区
    "渋谷": ["JR山手線", "JR埼京線", "JR湘南新宿ライン", "東京メトロ銀座線", "東京メトロ半蔵門線", "東京メトロ副都心線", "東急東横線", "東急田園都市線", "京王井の頭線"],
    "原宿": ["JR山手線", "東京メトロ千代田線", "東京メトロ副都心線"],
    "恵比寿": ["JR山手線", "JR埼京線", "JR湘南新宿ライン", "東京メトロ日比谷線"],
    "代々木": ["JR山手線", "JR中央線", "JR総武線", "都営大江戸線"],
    
    # 中野区
    "中野": ["JR中央線", "東京メトロ東西線"],
    "新中野": ["東京メトロ丸ノ内線"],
    "東中野": ["JR中央線", "都営大江戸線"],
    "野方": ["西武新宿線"],
    
    # 杉並区
    "荻窪": ["JR中央線", "東京メトロ丸ノ内線"],
    "高円寺": ["JR中央線"],
    "阿佐ヶ谷": ["JR中央線"],
    "西荻窪": ["JR中央線"],
    
    # 豊島区
    "池袋": ["JR山手線", "JR埼京線", "JR湘南新宿ライン", "東武東上線", "西武池袋線", "東京メトロ丸ノ内線", "東京メトロ有楽町線", "東京メトロ副都心線"],
    "巣鴨": ["JR山手線", "都営三田線"],
    "大塚": ["JR山手線", "東京メトロ丸ノ内線"],
    "目白": ["JR山手線"],
    
    # 北区
    "赤羽": ["JR京浜東北線", "JR埼京線", "JR宇都宮線", "JR高崎線", "JR湘南新宿ライン"],
    "王子": ["JR京浜東北線", "東京メトロ南北線", "都電荒川線"],
    "田端": ["JR山手線", "JR京浜東北線"],
    "十条": ["JR埼京線"],
    
    # 荒川区
    "日暮里": ["JR山手線", "JR京浜東北線", "JR常磐線", "京成本線", "日暮里・舎人ライナー"],
    "西日暮里": ["JR山手線", "JR京浜東北線", "東京メトロ千代田線", "日暮里・舎人ライナー"],
    "南千住": ["JR常磐線", "東京メトロ日比谷線", "つくばエクスプレス"],
    "町屋": ["東京メトロ千代田線", "京成本線", "都電荒川線"],
    
    # 板橋区
    "板橋": ["JR埼京線"],
    "成増": ["東京メトロ有楽町線", "東京メトロ副都心線"],
    "大山": ["東武東上線"],
    "志村坂上": ["都営三田線"],
    
    # 練馬区
    "練馬": ["西武池袋線", "西武豊島線", "都営大江戸線"],
    "光が丘": ["都営大江戸線"],
    "石神井公園": ["西武池袋線"],
    "大泉学園": ["西武池袋線"],
    
    # 足立区
    "北千住": ["JR常磐線", "東京メトロ千代田線", "東京メトロ日比谷線", "東武伊勢崎線", "つくばエクスプレス"],
    "綾瀬": ["JR常磐線", "東京メトロ千代田線"],
    "西新井": ["東武伊勢崎線", "東武大師線"],
    "竹ノ塚": ["東武伊勢崎線"],
    
    # 葛飾区
    "亀有": ["JR常磐線"],
    "金町": ["JR常磐線", "京成金町線"],
    "新小岩": ["JR総武線"],
    "青砥": ["京成本線", "京成押上線"],
    
    # 江戸川区
    "小岩": ["JR総武線"],
    "新小岩": ["JR総武線"],
    "葛西": ["東京メトロ東西線"],
    "西葛西": ["東京メトロ東西線"],
    "船堀": ["都営新宿線"],
    "一之江": ["都営新宿線"],
}

# 町名と最寄り駅の簡易マッピング（一部のみ）
TOWN_STATION_MAPPING = {
    "千代田区": {
        "丸の内": "東京",
        "大手町": "大手町",
        "有楽町": "有楽町",
        "霞が関": "霞ヶ関",
        "永田町": "永田町",
        "麹町": "麹町",
        "神田": "神田",
        "秋葉原": "秋葉原",
        "九段": "九段下",
        "飯田橋": "飯田橋",
    },
    "葛飾区": {
        "亀有": "亀有",
        "金町": "金町",
        "新小岩": "新小岩",
        "青戸": "青砥",
        "高砂": "京成高砂",
        "柴又": "柴又",
        "立石": "京成立石",
        "四つ木": "四ツ木",
        "堀切": "堀切菖蒲園",
        "お花茶屋": "お花茶屋",
    },
    # 他の区も必要に応じて追加
}

def get_station_for_town(ward: str, town: str) -> Optional[str]:
    """町名から最寄り駅を取得"""
    if ward in TOWN_STATION_MAPPING:
        ward_mapping = TOWN_STATION_MAPPING[ward]
        # 部分一致で検索
        for town_key, station in ward_mapping.items():
            if town_key in town or town in town_key:
                return station
    return None

def get_lines_for_station(station: str) -> List[str]:
    """駅名から路線リストを取得"""
    return STATION_LINE_MAPPING.get(station, [])

def process_townlist_with_stations(input_csv: str, output_csv: str):
    """町名リストに駅・路線情報を追加"""
    
    # 入力CSVを読み込み
    with open(input_csv, 'r', encoding='utf-8-sig') as f:
        reader = csv.DictReader(f)
        towns = list(reader)
    
    # 出力データ
    output_data = []
    station_found_count = 0
    
    for town in towns:
        ward_name = town['区名']
        town_name = town['町名']
        
        # 駅を検索
        station = get_station_for_town(ward_name, town_name)
        
        if station:
            lines = get_lines_for_station(station)
            line_str = '、'.join(lines)
            station_info = f"{station}｜{line_str}" if lines else station
            station_found_count += 1
        else:
            station_info = ""
            lines = []
        
        output_data.append({
            '区名': ward_name,
            '町名': town_name,
            '駅情報': station_info,
            '最寄り駅': station,
            '路線': '、'.join(lines) if lines else ""
        })
    
    # CSVに保存
    with open(output_csv, 'w', encoding='utf-8-sig', newline='') as f:
        fieldnames = ['区名', '町名', '駅情報', '最寄り駅', '路線']
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(output_data)
    
    print(f"完了: {output_csv} に保存しました")
    print(f"駅情報が見つかった町: {station_found_count}/{len(towns)} ({station_found_count/len(towns)*100:.1f}%)")

def main():
    input_csv = '/Users/mitsuimasaharu/Downloads/tokyo_23ku_townlist.csv'
    output_csv = '/Users/mitsuimasaharu/Documents/CLI_CODE/tochijihai/tokyo-wellbeing-map/backend/app/data/tokyo_townlist_stations_manual.csv'
    
    process_townlist_with_stations(input_csv, output_csv)

if __name__ == "__main__":
    main()